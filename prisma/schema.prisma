// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    String                @id @default(cuid())
  name                  String?
  email                 String?               @unique
  emailVerified         DateTime?
  image                 String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  accounts              Account[]
  sessions              Session[]
  memberships           Membership[]
  createdApplications   Application[]         @relation("ApplicationCreatedBy")
  updatedApplications   Application[]         @relation("ApplicationUpdatedBy")
  submittedApplications Application[]         @relation("ApplicationSubmittedBy")
  uploadedDocuments     ApplicationDocument[] @relation("UploadedDocuments")
  comments              ApplicationComment[]  @relation("CommentAuthor")
  auditEntries          AuditLog[]            @relation("UserAuditLogs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

model Organization {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  logoUrl         String?
  freshdeskDomain String?
  freshdeskApiKey String?
  emailTemplate   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  members         Membership[]
  applications    Application[] @relation("OrganizationApplications")
  auditLogs       AuditLog[]    @relation("OrganizationAuditLogs")
  suppliers       Supplier[]    @relation("SupplierOrganizations")
}

model Membership {
  id             String         @id @default(cuid())
  userId         String
  organizationId String
  role           MembershipRole @default(MEMBER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

model Entity {
  id           String            @id @default(cuid())
  name         String
  code         String            @unique
  description  String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  formConfigs  FormConfig[]
  applications Application[]
  geographies  EntityGeography[]
  suppliers    Supplier[]        @relation("SupplierEntities")
}

model Geography {
  id           String            @id @default(cuid())
  code         String            @unique
  name         String
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  formConfigs  FormConfig[]
  applications Application[]
  entities     EntityGeography[]
  suppliers    Supplier[]        @relation("SupplierGeographies")
}

model EntityGeography {
  id          String    @id @default(cuid())
  entityId    String
  geographyId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  entity      Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  geography   Geography @relation(fields: [geographyId], references: [id], onDelete: Cascade)

  @@unique([entityId, geographyId])
}

model FormConfig {
  id            String                    @id @default(cuid())
  entityId      String
  geographyId   String
  version       Int
  isActive      Boolean                   @default(true)
  title         String?
  description   String?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  entity        Entity                    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  geography     Geography                 @relation(fields: [geographyId], references: [id], onDelete: Cascade)
  sections      FormSection[]
  documentRules FormDocumentRequirement[]
  applications  Application[]

  @@unique([entityId, geographyId, version])
}

model FormSection {
  id           String      @id @default(cuid())
  formConfigId String
  key          String
  label        String
  order        Int
  visibility   Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  formConfig   FormConfig  @relation(fields: [formConfigId], references: [id], onDelete: Cascade)
  fields       FormField[]
}

model FormField {
  id          String      @id @default(cuid())
  sectionId   String
  key         String
  label       String
  type        String
  placeholder String?
  helpText    String?
  required    Boolean     @default(false)
  options     Json?
  validation  Json?
  visibility  Json?
  order       Int         @default(0)
  isSensitive Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  section     FormSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([sectionId, key])
}

model DocumentType {
  id                   String                    @id @default(cuid())
  key                  String                    @unique
  label                String
  category             String
  description          String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  requirements         FormDocumentRequirement[]
  applicationDocuments ApplicationDocument[]
  supplierDocuments    SupplierDocument[]        @relation("SupplierDocuments")
}

model FormDocumentRequirement {
  id             String       @id @default(cuid())
  formConfigId   String
  documentTypeId String
  required       Boolean      @default(true)
  helpText       String?
  formConfig     FormConfig   @relation(fields: [formConfigId], references: [id], onDelete: Cascade)
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)

  @@unique([formConfigId, documentTypeId])
}

model Application {
  id              String                @id @default(cuid())
  organizationId  String
  entityId        String
  geographyId     String
  formConfigId    String?
  status          ApplicationStatus     @default(DRAFT)
  version         Int                   @default(1)
  data            Json?
  hiddenSections  String[]              @default([])
  submittedAt     DateTime?
  submittedById   String?
  submissionType  String? // 'SUPPLIER' or 'INTERNAL'
  supplierId      String? // Link to Supplier if this is an update/re-approval request
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  pendingSince    DateTime?
  createdById     String
  updatedById     String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  organization    Organization          @relation("OrganizationApplications", fields: [organizationId], references: [id], onDelete: Cascade)
  entity          Entity                @relation(fields: [entityId], references: [id], onDelete: Cascade)
  geography       Geography             @relation(fields: [geographyId], references: [id], onDelete: Cascade)
  formConfig      FormConfig?           @relation(fields: [formConfigId], references: [id])
  createdBy       User                  @relation("ApplicationCreatedBy", fields: [createdById], references: [id])
  updatedBy       User?                 @relation("ApplicationUpdatedBy", fields: [updatedById], references: [id])
  submittedBy     User?                 @relation("ApplicationSubmittedBy", fields: [submittedById], references: [id])
  supplier        Supplier?              @relation("SupplierUpdateApplications", fields: [supplierId], references: [id])
  supplierCreated Supplier?              @relation("SupplierApplication")
  comments        ApplicationComment[]
  documents       ApplicationDocument[]
  auditLogs       AuditLog[]

  @@index([organizationId])
  @@index([entityId])
  @@index([geographyId])
  @@index([status])
  @@index([organizationId, formConfigId, status])
}

model ApplicationDocument {
  id             String       @id @default(cuid())
  applicationId  String
  documentTypeId String
  fileName       String
  fileUrl        String
  mimeType       String?
  fileSize       Int?
  uploadedById   String
  uploadedAt     DateTime     @default(now())
  application    Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  uploadedBy     User         @relation("UploadedDocuments", fields: [uploadedById], references: [id], onDelete: Cascade)
}

model ApplicationComment {
  id            String      @id @default(cuid())
  applicationId String
  authorId      String
  body          String
  visibility    String      @default("supplier_visible")
  fieldKey      String?
  createdAt     DateTime    @default(now())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  author        User        @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model AuditLog {
  id             String          @id @default(cuid())
  actorId        String?
  actorRole      MembershipRole?
  organizationId String?
  applicationId  String?
  action         String
  details        Json?
  createdAt      DateTime        @default(now())
  actor          User?           @relation("UserAuditLogs", fields: [actorId], references: [id], onDelete: SetNull)
  application    Application?    @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  organization   Organization?   @relation("OrganizationAuditLogs", fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([applicationId])
  @@index([createdAt])
}

enum MembershipRole {
  ADMIN
  MEMBER
  SUPPLIER
  PROCUREMENT
  MDM
}

model Supplier {
  id              String   @id @default(cuid())
  organizationId  String
  entityId        String
  geographyId     String
  applicationId   String   @unique // The Application that created this Supplier
  supplierId      String?  @unique // External supplier ID (ERP, etc.)
  data            Json     // Supplier information (same structure as Application.data)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation("SupplierOrganizations", fields: [organizationId], references: [id], onDelete: Cascade)
  entity          Entity   @relation("SupplierEntities", fields: [entityId], references: [id], onDelete: Cascade)
  geography       Geography @relation("SupplierGeographies", fields: [geographyId], references: [id], onDelete: Cascade)
  application     Application @relation("SupplierApplication", fields: [applicationId], references: [id], onDelete: Cascade)
  documents       SupplierDocument[]
  updateApplications Application[] @relation("SupplierUpdateApplications")
  
  @@index([organizationId])
  @@index([entityId])
  @@index([geographyId])
  @@index([applicationId])
}

model SupplierDocument {
  id              String   @id @default(cuid())
  supplierId      String
  documentTypeId  String
  fileName        String
  fileUrl         String
  mimeType        String?
  fileSize        Int?
  uploadedAt      DateTime @default(now())
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  documentType    DocumentType @relation("SupplierDocuments", fields: [documentTypeId], references: [id], onDelete: Cascade)
  
  @@index([supplierId])
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  PENDING_SUPPLIER
  APPROVED
  REJECTED
}
